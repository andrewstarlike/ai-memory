version: '3.8'

services:
  neo4j:
    image: neo4j:5.26.0
    container_name: graphiti_neo4j
    restart: unless-stopped
    ports:
      - "127.0.0.1:7474:7474"
      - "127.0.0.1:7687:7687"
    volumes:
      - ./neo4j_data:/data
    environment:
      - NEO4J_AUTH=${NEO4J_USERNAME}/${NEO4J_PASSWORD}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=1G
      - NEO4J_dbms_memory_pagecache_size=512m
    deploy:
      resources:
        limits:
          memory: 2G
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - graphiti_network

  graphiti_app:
    image: python:3.11-slim
    container_name: graphiti_app
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./graphiti_app:/app
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=${NEO4J_USERNAME}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
    ports:
      - "127.0.0.1:8001:8001"
    deploy:
      resources:
        limits:
          memory: 1G
    command: >
      bash -c "
        apt-get update && apt-get install -y curl &&
        pip install --no-cache-dir graphiti-core quart neo4j openai &&
        sleep 10 &&
        python -u /app/main.py
      "
    depends_on:
      neo4j:
        condition: service_healthy
    networks:
      - graphiti_network

networks:
  graphiti_network:
    driver: bridge